<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rehab Progress</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }

    input, button, select {
      margin: 10px;
    }

    #step-count {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <main>
    <h1>Rehab Progress</h1>
    <label for="start-date">Start Date:</label>
    <input type="date" id="start-date" required>

    <p>Current Step Count: <span id="step-count">0</span></p>

    <label for="mood">Mood:</label>
    <select id="mood" required>
      <option value="">Select mood</option>
      <option value="good">Good</option>
      <option value="average">Average</option>
      <option value="bad">Bad</option>
    </select>

    <label for="fatigue">Fatigue:</label>
    <select id="fatigue" required>
      <option value="">Select fatigue level</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>

    <label for="pain">Pain:</label>
    <select id="pain" required>
      <option value="">Select pain level</option>
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>

    <button id="reminder-btn">Bed Exercise Reminder</button>
    <button id="email-btn">Email Data</button>
  </main>

  <script>
    // Step counting
    let stepCount = 0;
    const stepCountDisplay = document.getElementById('step-count');
    let accelerationBuffer = [];
    let lastStepTime = 0;
    const stepThreshold = 1.2; // Adjust this value for better step detection
    const stepInterval = 300; // Minimum time between steps in milliseconds
    const stepPeakDuration = 150; // Maximum duration of a step peak in milliseconds

    window.addEventListener('devicemotion', handleMotion);

    function handleMotion(event) {
      const acceleration = event.accelerationIncludingGravity;
      const accelerationMagnitude = Math.sqrt(acceleration.x ** 2 + acceleration.y ** 2 + acceleration.z ** 2);

      accelerationBuffer.push({ value: accelerationMagnitude, timestamp: event.timeStamp });

      // Apply low-pass filter to smooth the signal
      const filteredAcceleration = lowPassFilter(accelerationBuffer, 0.2);

      // Check for step pattern and adaptive threshold
      const currentTime = new Date().getTime();
      if (filteredAcceleration > stepThreshold && currentTime - lastStepTime > stepInterval) {
        const stepStart = accelerationBuffer.findLastIndex(
          (a) => a.value < stepThreshold && a.timestamp < event.timeStamp - stepPeakDuration
        );
        const stepEnd = accelerationBuffer.findIndex(
          (a) => a.value < stepThreshold && a.timestamp > event.timeStamp
        );

        if (stepEnd - stepStart > 1) {
          stepCount++;
          stepCountDisplay.textContent = stepCount;
          lastStepTime = currentTime;
        }
      }

      // Remove older acceleration values from the buffer
      accelerationBuffer = accelerationBuffer.slice(-30);
    }

    function lowPassFilter(data, alpha) {
      let lastValue = data[0].value;
      const filteredData = data.map(({ value, timestamp }) => {
        const filteredValue = alpha * value + (1 - alpha) * lastValue;
        lastValue = filteredValue;
        return { value: filteredValue, timestamp };
      });
      return filteredData[filteredData.length - 1].value;
    }

    // Data storage
    const startDateInput = document.getElementById('start-date');
    const moodSelect = document.getElementById('mood');
    const fatigueSelect = document.getElementById('fatigue');
    const painSelect = document.getElementById('pain');

    function saveData() {
      const data = {
        startDate: startDateInput.value,
        stepCount: stepCount,
        mood: moodSelect.value,
        fatigue: fatigueSelect.value,
        pain: painSelect.value
      };
      localStorage.setItem('rehabData', JSON.stringify(data));
    }

    // Haptic reminder
    const reminderBtn = document.getElementById('reminder-btn');
    reminderBtn.addEventListener('click', () => {
      window.navigator.vibrate(200); // Vibrate for 200ms
    });

    // Email functionality
    const emailBtn = document.getElementById('email-btn');
    emailBtn.addEventListener('click', sendEmail);

    function sendEmail() {
      const data = JSON.parse(localStorage.getItem('rehabData'));
      const emailBody = `
        Start Date: ${data.startDate}
        Step Count: ${data.stepCount}
        Mood: ${data.mood}
        Fatigue: ${data.fatigue}
        Pain: ${data.pain}
      `;

      // Use a third-party email API or backend service to send the email
      // Example using the mailto: protocol (this will open the user's default email client)
      window.location.href = `mailto:?subject=Rehab Progress Data&body=${encodeURIComponent(emailBody)}`;
    }

    // Save data on page unload
    window.addEventListener('beforeunload', saveData);
  </script>
</body>
</html>
